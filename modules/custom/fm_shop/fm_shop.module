<?php
/**
 * Implements hook_menu().
 */
function fm_shop_menu() {
	
	$items['shop'] = array(
    'page callback' => 'fm_shop_page',
	  'access arguments' => array('view deals'),
    'type' => MENU_NORMAL_ITEM,
  );
  
  
  return $items;
}

/**
 * Implements hook_theme().
 */
function fm_shop_theme() {
  return array(
    'fm_shop_page' => array(
	     'variables' => array('filters' => '', 'content' => ''),
	    'template' => 'fm_shop_page'
    ),
    'fm_shop_page_panel' => array(
	     'variables' => array('shop' => NULL, 'products' => NULL),
       'template' => 'fm_shop_page_panel'
    ),
    'fm_shop_page_panel_thumb' => array(
	     'variables' => array('product' => NULL, 'height' => 446, 'width' => 315),
       'template' => 'fm_shop_page_panel_thumb'
    ),
  );
}

function fm_shop_page() {

	drupal_add_js(path_to_theme() . '/js/jquery.capSlide.js');
  drupal_add_css(path_to_theme() . '/css/captions.css');
    
  $content = array();
  $filters = fm_shop_page_filters();
  
  foreach($filters as $filter_group) {
  	$title = $filter_group['title'];
  	$content[$title] = array();
    foreach($filter_group['links'] as $id => $link) {
    	$shop = fm_commerce_store_load($id);
    	$products = fm_commerce_store_get_products($shop);
    	
    	//Filter products without a Display node
    	foreach($products as $id => $product) {
    		$node = fm_commerce_get_display_node($product);
    		if(!isset($node)) {
    		 unset($products[$id]);
    		}
    	}
    	if(!empty($products)) {
    	  $content[$title][] = theme('fm_shop_page_panel', array('shop' => $shop, 'products' => $products));
    	}
    }
  } 
  
  return theme('fm_shop_page', array('filters' => $filters, 'content' => $content));
}

function fm_shop_page_filters() {
	$filters = array();
//Get Featured List 
	$filters['featured']['title'] = t('Featured');
	$filters['featured']['links'] = array();
	
	
	$query = new EntityFieldQuery();
	$query->entityCondition('entity_type', 'fm_commerce_store');
	$query->propertyCondition('status', 1);
	$query->fieldCondition('field_featured', 'value', 1);
	$result = $query->execute();
	
  $matches = array();
  foreach ($result['fm_commerce_store'] as $store_id => $store) {
    $shop = fm_commerce_store_load($store_id);
    $filters['featured']['links'][$shop->store_id] = check_plain($shop->name);
  }
  
	//Get Designer List
	$filters['designers']['title'] = t('Designers');
	$filters['designers']['links'] = array();
	
	$query = new EntityFieldQuery();
	$query->entityCondition('entity_type', 'fm_commerce_store');
	$query->propertyCondition('status', 1);
	$result = $query->execute();

  $matches = array();
  foreach ($result['fm_commerce_store'] as $store_id => $store) {
    $shop = fm_commerce_store_load($store_id);
    $shop_name = check_plain($shop->name);
    if(!in_array($shop_name, $filters['featured']['links'])) {
      $filters['designers']['links'][$shop->store_id] = $shop_name;
    }
  }
  
  return $filters;
}