<?php
/**
 * Implements hook_menu().
 */
function fm_shop_menu() {
	
	$items['shop'] = array(
    'page callback' => 'fm_shop_page',
	  'access arguments' => array('view deals'),
    'type' => MENU_NORMAL_ITEM,
  );
  
  $items['shop/ajax/%/%'] = array(
    'page callback' => 'fm_shop_page_ajax',
	  'access arguments' => array('view deals'), 
    'page arguments' => array(2, 3),
    'type' => MENU_NORMAL_ITEM,
  );
  
  
  return $items;
}

function fm_shop_init() {
	drupal_add_js(drupal_get_path('module', 'fm_shop') . '/fm_shop.js');
}

/**
 * Implements hook_theme().
 */
function fm_shop_theme() {
  return array(
    'fm_shop_page' => array(
	     'variables' => array('filters' => '', 'content' => ''),
	    'template' => 'fm_shop_page'
    ),
    'fm_shop_page_panel' => array(
	     'variables' => array('shop' => NULL, 'products' => NULL),
       'template' => 'fm_shop_page_panel'
    ),
    'fm_shop_page_panel_thumb' => array(
	     'variables' => array('product' => NULL, 'shop' => NULL,  'height' => 446, 'width' => 315),
       'template' => 'fm_shop_page_panel_thumb'
    ),
    'fm_shop_page_collection_slider' => array(
	     'variables' => array('products' => NULL),
       'template' => 'fm_shop_page_collection_slider'
    ),
    
  );
}

function fm_shop_page() {

	drupal_add_js(path_to_theme() . '/js/jquery.capSlide.js');
  drupal_add_css(path_to_theme() . '/css/captions.css');
  drupal_add_js(path_to_theme() . '/js/jquery.ad-gallery.js');
  drupal_add_css(path_to_theme() . '/css/jquery.ad-gallery.css');
  drupal_add_js(path_to_theme() . '/js/jquery-textFill.js');
    
  $filters = fm_shop_page_filters();
  //$content = fm_shop_page_all_panels($filters);
  
  return theme('fm_shop_page', array('filters' => $filters, 'content' => $content));
}

function fm_shop_page_ajax($type, $var) {
	
	if(isset($_GET['store_id']) && $_GET['store_id'] != '' ) {
		$store_id = $_GET['store_id'];
		$shop = fm_commerce_store_load($store_id);
		if($var == 'empty') {
			$products = fm_commerce_store_get_products($shop, true);
			$first_product = array_shift($products);
			$node = fm_commerce_get_display_node($first_product);
			$var = $node->nid;
		}
	}
			
	switch($type) {
		case 'all':
		  $filters = fm_shop_page_filters();
		  $content = '<div id="all">';
      $panels = fm_shop_page_all_panels($filters);
      foreach($panels as $panels_group) {
     	   foreach($panels_group as $panel) {
       	 	 $content .= $panel;
     	   }
       } 
      $content .= '</div>';
	    break;
		case 'node':
		  $node = node_load($var);
		  $node_content = render(node_view($node));;
		  if(isset ($shop)) {
		    $content =  fm_shop_collection_viewer('store', $shop);
		    $content .= '<div class="product_content">';
		    $content .= $node_content;
		    $content .= '</div>';
		  } else {
		  	$content = $node_content;
		  }
	    break;
		
	}
	
	print $content;
	exit();
}

function fm_shop_collection_viewer($type, $var) {

	$content = '';
	switch($type) {
		case 'store':
			$shop = $var;
			$products = fm_commerce_store_get_products($shop, true);
			$content = '<div id = "collection_store_' . $shop->store_id . '">';
			$content .= theme('fm_shop_page_collection_slider', array('products' => $products));
			$content .= '</div>';
			return $content;
			break;
		case '':
			break;
	}
	
}


function fm_shop_page_filters() {
	$filters = array();
//Get Featured List 
	$filters['featured']['title'] = t('Featured');
	$filters['featured']['links'] = array();
	
	
	$query = new EntityFieldQuery();
	$query->entityCondition('entity_type', 'fm_commerce_store');
	$query->propertyCondition('status', 1);
	$query->fieldCondition('field_featured', 'value', 1);
	$result = $query->execute();
	
  $matches = array();
  foreach ($result['fm_commerce_store'] as $store_id => $store) {
    $shop = fm_commerce_store_load($store_id);
    $filters['featured']['links'][$shop->store_id] = check_plain($shop->name);
  }
  
	//Get Designer List
	$filters['designers']['title'] = t('Designers');
	$filters['designers']['links'] = array();
	
	$query = new EntityFieldQuery();
	$query->entityCondition('entity_type', 'fm_commerce_store');
	$query->propertyCondition('status', 1);
	$result = $query->execute();

  $matches = array();
  foreach ($result['fm_commerce_store'] as $store_id => $store) {
    $shop = fm_commerce_store_load($store_id);
    $shop_name = check_plain($shop->name);
    if(!in_array($shop_name, $filters['featured']['links'])) {
      $filters['designers']['links'][$shop->store_id] = $shop_name;
    }
  }
  
  return $filters;
}

function fm_shop_page_all_panels($filters) {
	$content = array();
  
  foreach($filters as $filter_group) {
  	$title = $filter_group['title'];
  	$content[$title] = array();
    foreach($filter_group['links'] as $id => $link) {
    	$shop = fm_commerce_store_load($id);
    	$products = fm_commerce_store_get_products($shop, true);
    
    	if(!empty($products)) {
    	  $content[$title][] = theme('fm_shop_page_panel', array('shop' => $shop, 'products' => $products));
    	}
    }
  } 
  
  return $content;
}