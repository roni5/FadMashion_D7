<?php

/*
 * implements hook_block_info()
 */
function fm_commerce_cart_block_info() {
	$blocks = array();
	
	//Define the Preview Block
	$blocks['fm_commerce_cart'] = array(
	  'info' => t('FM Order Summary'),
	  'cache' => DRUPAL_NO_CACHE
	);
	return $blocks;
}

function fm_commerce_cart_theme() {
	return array(
    'fm_commerce_cart_line_item' => array(
	     'variables' => array(
         'title' => '',
	       'price' => '',
	       'red' => false
	    )
    ),
  );
}

function theme_fm_commerce_cart_line_item($vars) {
	$title = $vars['title'];
	$price = $vars['price'];
	$red = $vars['red'];
	
	$line_item_val = '<div class="item_wrapper">';
  $line_item_val .= '<div class="item_title">' . $title . '</div>';
  $line_item_val .= '<div class="item_value ' .($red ? 'red_val' : '') . '">' . $price . '</div>';
  $line_item_val .= '</div>';
  
  return $line_item_val;
}

/*
 * Implements hook_block_view
 */
function fm_commerce_cart_block_view($block_name = '') {
	drupal_add_js(drupal_get_path('theme', 'fadmashion_commerce').'/js/jquery.scrollfollow.js');
	
  if($block_name == 'fm_commerce_cart') {
  	
  	$output = '<div class="summary">';
  	$output .= '<div class="header"><a href="#">Show Details</a>Order Summary</div>';
  	
  	
  global $user;
	// First attempt to load the customer's shopping cart order.
  $order = commerce_cart_order_load($user->uid);

  // If no order existed, create one now.
  if (empty($order)) {
  	drupal_set_message('There was an error with your order, please contact the admin for issues', 'error');
    drupal_goto();
  }
  // Wrap the order for easy access to field data.
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
  
  $product_line_items = array();
  $discount_line_items = array();
  // Loop through the line items looking for products.
  foreach ($order_wrapper->commerce_line_items as $delta => $line_item_wrapper) {
  
  	if ($line_item_wrapper->type->value() == 'product' ) {
       // Exit this loop with the $line_item intact so it gets updated.
       
       $product = $line_item_wrapper->commerce_product->value();
       $title = $product->title;
       $retail_price = $line_item_wrapper->commerce_total->value();
       
       $product_line_items[] = theme('fm_commerce_cart_line_item', array('title' => $title, 
                                     'price' => commerce_currency_format($retail_price['amount'], $retail_price['currency_code']))
                                    );
     }
     
     // If this line item matches the product being added...
     if ($line_item_wrapper->type->value() == 'deals_discount' ) {
       // Exit this loop with the $line_item intact so it gets updated.
	     $discount_price = $line_item_wrapper->commerce_total->value();
	     $discount_time = $line_item_wrapper->field_product_line_item->field_node_reference->field_start_time->value();
	     
       $discount_line_items[] = theme('fm_commerce_cart_line_item', array('title' => 'Discount', 
                                     'price' => commerce_currency_format($discount_price['amount'], $discount_price['currency_code']),
                                     'red' => true)
                                    );
     }
  }
  
  var_dump($product_line_items);
  var_dump($discount_line_items);
  
  $output .= '<div class="pad">';
  $output .= implode('', $product_line_items);
  $output .= implode('', $discount_line_items);
  $output .= '<div class="alert"><div>Deal expires in <span class="timer-detail">00:00</span></div></div>';
  
  $untilTime = date("F d, Y g:i a", strtotime($discount_time['value2']));
  //If start time is LESS THAN NOW this is ACTIVE
	jquery_countdown_add(".timer-detail", array("until" =>  $untilTime, 'format' => 'DHMS', "layout" => '{mnn}:{snn}'));
  
  
  $total = $order_wrapper->commerce_order_total->value();
  $output .= '<div id="item_total_wrapper">';
  $output .= theme('fm_commerce_cart_line_item', array('title' => 'Total', 
                                     'price' => commerce_currency_format($total['amount'], $total['currency_code'], NULL, true),
                                    ));
   $output .= '</div>';
                                    
  $output .='</div>';  //end class="pad"
  
  $output .= '</div>'; //End class="summary"
  
    $block = array(
      'content' => $output
    );
  }
  return $block;
}