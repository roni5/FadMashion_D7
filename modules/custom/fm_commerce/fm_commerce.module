<?php

/**
 * Implements hook_form_alter().
 * 
 * Change the Add to Cart form to add Colors/Sizes and custom Submit function
 */
function fm_commerce_form_alter(&$form, $form_state, $form_id) {
	
	$posi = strpos($form_id, 'commerce_cart_add_to_cart_form');  
  if (is_numeric($posi)){
  	
  	drupal_add_library('jquery_plugin', 'validate');
  	
  	$node = $form_state['build_info']['args']['4']['options']['entity'];
	  $product = fm_deals_get_product($node);
	  
	  $colors = fm_commerce_color_options($product);
	  $sizes = fm_commerce_color_options($product);
	  
	  //ADD color options to cart form
	  if (count($colors) > 1) {
	    $form['colors'] = array(
	       '#type' => 'select',
	       '#title' => t('Select Colors'),
	       '#options' => $colors,
         '#weight' => -1,
	      '#attributes' => array('size' => count($colors))
	    );
	  }
    if (count($sizes) > 1) {
	    $form['sizes'] = array(
	       '#type' => 'select',
	       '#title' => t('Select Sizes'),
	       '#options' => $sizes,
         '#weight' => -5,
	       '#attributes' => array('size' => count($sizes))
	    );
	  }
	   
	  if(count($colors) > 1 || count($sizes) > 1) {
	    $form['#attached']['js'] = array(
        drupal_get_path('module', 'fm_commerce_color') . '/fm_commerce_color.js',
        drupal_get_path('theme', 'fadmashion_commerce') . '/js/jquery.selectBox.min.js'
      );
	  }
	  
	  $form['#id'] = "commerce-cart-add-to-cart-form";
	  
		$form['submit']['#value'] = "Purchase Now";
		$form['submit']['#attributes'] = array(
		  'class' => array('red')
    );
		$form['#submit'][] = 'fm_commerce_cart_submit';
  }
}

//REDIRECTS Deals page TO STEP 2 after submit
function fm_commerce_cart_submit ($form, &$form_state) {
	$node_entity = $form_state['values']['display_uri']['options']['entity'];
	
	$line_item = $form_state['line_item'];
	$line_item_wrapper = entity_metadata_wrapper('commerce_line_item', $line_item);
	$line_item_wrapper->field_node_reference = $node_entity->nid;
	
	//SPECIAL FOR QUANTITIES OF 1
	$line_item_wrapper->quantity = 1;
	
	$line_item = commerce_line_item_save($line_item);
	
	
	//ADD the Discount Line Type
	
	$node = node_load($node_entity->nid);
  $sale_price = $node->field_sale_price['und'][0]['amount'];

	global $user;
	// First attempt to load the customer's shopping cart order.
  $order = commerce_cart_order_load($user->uid);

  // If no order existed, create one now.
  if (empty($order)) {
    return NULL;
  }
  // Wrap the order for easy access to field data.
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
  
  $discount_line_item = NULL;
  // Loop through the line items looking for products.
  foreach ($order_wrapper->commerce_line_items as $delta => $line_item_wrapper) {
     // If this line item matches the product being added...
     if (empty($line_item) &&
         $line_item_wrapper->type->value() == 'deals_discount' ) {
       // Exit this loop with the $line_item intact so it gets updated.
       $discount_line_item = $line_item_wrapper->value();
     }
  }

  if (empty($discount_line_item)) { 
    $discount_line_item = fm_commerce_deals_discout_line_item_new($order->order_id);
  }
	
	$discount_line_item_wrapper = entity_metadata_wrapper('commerce_line_item', $discount_line_item);
	$discount_line_item_wrapper->field_deal_node_reference = $node_entity->nid;
	
	$discount_line_item_wrapper->commerce_unit_price->amount = commerce_currency_decimal_to_amount($sale_price, 'USD');
  $discount_line_item_wrapper->commerce_unit_price->currency_code = 'USD';
  $discount_line_item_wrapper->commerce_unit_price->data = commerce_price_component_add(
    $discount_line_item_wrapper->commerce_unit_price->value(),
    'base_price',
    $discount_line_item_wrapper->commerce_unit_price->value(),
    TRUE
  );
	
  // Save the line item now so we get its ID.
  $discount_line_item = commerce_line_item_save($discount_line_item);
  
  // Add it to the order's line item reference value.
  $order_wrapper->commerce_line_items[] = $discount_line_item;
    
  // Save the updated order.
  commerce_order_save($order);
  
   //code here
  $form_state['redirect'] = 'checkout'; 
}

function fm_commerce_color_options($product) {
	$images = field_get_items('commerce_product', $product, 'field_images');
	
	$colors = array();
	foreach($images as $pos => $image) {
		//check if it isn't 
		if(!empty($image['fm_commerce_color_hex'])  && $image['fm_commerce_color_hex'] != 'ffffff') {
		  $colors[$image['fm_commerce_color_hex']] = $pos;
		  
		}
	}
	return $colors;
}

function fm_commerce_size_options($product) {
	
	$product_sizes = field_get_items('commerce_product', $product, 'field_product_sizes');
  $tableData = $product_sizes[0]['tabledata'];
  $header = $tableData[0];
	
	$sizes = array();
	foreach($header as $pos => $size) {
		//check if it isn't 
		if($size != '') {
		  $sizes[$size] = $size;
		} 
	}
	return $sizes;
}
