<?php

function fm_users_menu() {
  $items['fm_users/auth'] = array(
    'page callback' => 'fm_users_authorize',
    'access callback' => TRUE,
    'type' => MENU_NORMAL_ITEM,
  );
  $items['fm_users/email-verify'] = array(
    'page callback' => 'fm_users_email_verify',
    'access callback' => TRUE,
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;	
}

function fm_users_email_verify() {
  $mail = $_POST['mail'];
  if ($val = db_query("SELECT mail FROM {users} WHERE LOWER(mail) = LOWER(:mail)", array(
      ':mail' => $mail,))->fetchField()) {
      print drupal_json_encode(false);
  }
  else {
  	print drupal_json_encode(true);
  }
  exit();
}
function fm_users_authorize() {
	$username = $_POST['username'];
	$pass = $_POST['pass'];
	
	$uid = user_authenticate($username, $pass);
	
	if($uid) {
	  print drupal_json_encode(true);
	}
	else { 
		if ($name = db_query("SELECT name FROM {users} WHERE LOWER(mail) = LOWER(:name)", array(
      ':name' => $username,))->fetchField()) {
      $uid = user_authenticate($name, $pass);
      
      if($uid) {
      	print drupal_json_encode(true);
      } else {
        print drupal_json_encode(false);
      }
    }
		
	}
	exit();
}

/**
 * Implements hook_form_alter().
 * 
 * changes the user login form to be something else
 */
function fm_users_form_alter(&$form, $form_state, $form_id) {
	
  switch ($form_id){
  	case 'user_login_block':  
  		//ADD JS for User validation and AJAXY functionality
  		drupal_add_js(drupal_get_path('module', 'fm_users').'/fm_users.js');
  		drupal_add_js(path_to_theme().'/js/jquery-ajaxy/scripts/jquery.ajaxy.js');
  		
	    unset($form['name']['#title']);
	    unset($form['pass']['#title']);
	    $form['links']['#markup'] = '<a class="forgotPassword" href="#">Forgot password?</a>';
    	$form['links']['#weight'] = -10;
    	
  	  $form['name']['#default_value'] = t('Email');
  	  $form['name']['#attributes'] = array('class' => array('clear-defaults'));
  	  $form['name']['#weight'] = -20;
  	
  	  $form['pass']['#default_value'] = t('Password');
  	  $form['pass']['#attributes'] = array('class' => array('clear-defaults'));
  	  $form['pass']['#weight'] = -18;
  	  $form['pass']['#suffix'] = '<div style="clear: both; display: block;margin: 0px; font-size: 1px;"></div>';
  	  
 	
  	  $form['pass']['#attributes'] = array('class' => array('clear-defaults'));
  	  
  	  $form['pass-clear'] = array(
  	     '#type' => 'textfield', 
         '#default_value' => t('Password'), 
  	     '#weight' => -19,
  	  );
  	  
  	  break;
  	case 'user_register_form':
  		//ADD JS for User validation and AJAXY functionality
  		drupal_add_js(drupal_get_path('module', 'fm_users').'/fm_users.js');
  		drupal_add_js(path_to_theme().'/js/jquery-ajaxy/scripts/jquery.ajaxy.js');
  		
  		unset($form['account']['name']);
  		
  		unset($form['account']['mail']['#title']);
  		unset($form['account']['mail']['#description']);
  		$form['account']['mail']['#default_value'] = t('Email');
  	  $form['account']['mail']['#attributes'] = array('class' => array('clear-defaults'));
  	  $form['account']['mail']['#weight'] = -48;
  	  $form['account']['#weight'] = -48;
  		
  		unset($form['account']['pass']['#title']);
  		unset($form['account']['pass']['#description']);
  		$form['account']['pass']['#weight'] = -11;
  		
  		$form['field_first_name']['#weight'] = -50;
  		$form['field_first_name']['und'][0]['value']['#default_value'] = t('First Name');
  		//$form['field_first_name']['#default_value'] = t('First Name');
  	  $form['field_first_name']['und'][0]['value']['#attributes'] = array('class' => array('clear-defaults'));
  		$form['field_last_name']['#weight'] = -49;
  		$form['field_last_name']['und'][0]['value']['#default_value'] = t('Last Name');
  	  $form['field_last_name']['und'][0]['value']['#attributes'] = array('class' => array('clear-defaults'));
  	  $form['field_last_name']['#suffix'] = '<div style="clear: both; display: block;margin: 0px; font-size: 1px;"></div>';
  	  
  	  $form['field_tos']['und']['#title'] = t('I agree to the ') . l('terms of service', '#');
  	  $form['field_newsletter_week']['und']['#title'] = t('Sign me up for weekly Deal Reminders');
  	  $form['field_tos']['und']['#weight'] = 2;
  	  $form['field_newsletter_week']['und']['#weight'] = 3;
  	  
  	  $form['actions']['submit']['#value'] = t('Sign me up!');
  	  $form['actions']['submit']['#attributes'] = array('class' => array('red'));
  	  
  	  $form['pass-clear'] = array(
  	     '#type' => 'textfield', 
         '#default_value' => t('Password'), 
  	     '#weight' => 4,
  	  );
  	  $form['pass-confirm-clear'] = array(
  	     '#type' => 'textfield', 
         '#default_value' => t('Confirm Password'), 
  	     '#weight' => 5,
  	  );
  	  
  		break;	
  }
  
  drupal_add_js('var base_path = "' . check_plain(url('', array('absolute' =>true))) . '";', 'inline');
}

//Generate Username from first and last name.
function fm_users_user_presave (&$edit, $account, $category) {
	// Make sure that our form value 'mymodule_foo' is stored as 'mymodule_bar'.
	
	//Generate name from registration form
	if(isset($edit['field_first_name']) && isset($edit['field_last_name'])) {
	  $first_name = $edit['field_first_name']['und'][0]['value'];
	  $last_name = $edit['field_last_name']['und'][0]['value'];
	  $edit['name'] = $first_name . ' ' . $last_name;
	}
	else { 
	  $fbu = fb_facebook_user();
	  if(isset($fbu)) {
	  	
	var_dump($edit);
	
	$info = $GLOBALS['_fb']->api($fbu);
	var_dump( $info);
		exit();
	  }

	}
}

function fm_users_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'form_alter') {
    // Move my_module_rdf_mapping() to the end of the list. module_implements()
    // iterates through $implementations with a foreach loop which PHP iterates
    // in the order that the items were added, so to move an item to the end of
    // the array, we remove it and then add it.
    $group = $implementations['fm_users'];
    unset($implementations['fm_users']);
    $implementations['fm_users'] =  $group;
    
  }
}
